<html>
  <head>
    <title>Address History</title>
    <link type="text/css" rel="stylesheet" href="bower_components/materialize/dist/css/materialize.min.css"  media="screen,projection"/>
    <link type="text/css" rel="stylesheet" href="custom.css"/>
    <script src="http://fb.me/react-0.12.2.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="bower_components/materialize/dist/js/materialize.min.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx">

      var AddressBox = React.createClass({
        loadAddressesFromServer: function() {
          $.ajax({
            url: this.props.url,
            dataType: 'json',
            success: function(data) {
              this.setState({data: data});
            }.bind(this),
            error: function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },
        handleAddressSubmit: function(address) {
          var addresses = this.state.data;
          var newAddresses = addresses.concat([address]);
          this.setState({data: newAddresses});
        },
        getInitialState: function() {
          return {data: []};
        },
        componentDidMount: function() {
          this.loadAddressesFromServer();
        },
        render: function() {
          return (
            <div className="addressBox">
              <h3>Address History</h3>
              <AddressList data={this.state.data} />
              <AddressForm onAddressSubmit={this.handleAddressSubmit} />
            </div>
          );
        }
      });

      var AddressList = React.createClass({
        getInitialState: function() {
          return ({
            data: null
          })
        },
        handleClicked: function(addressObj) {
          var addresses = this.props.data;
          var address = {'street_address': addressObj.props.street_address, 'unit_number': addressObj.props.unit_number, 'city': addressObj.props.city, 'province': addressObj.props.province, 'postal_code': addressObj.props.postal_code};
          var index = addresses.map(function(address) {return address.street_address}).indexOf(address.street_address);
          if (index > -1) {
            addresses.splice(index, 1)
          };
          this.setState({data: addresses})
        },
        render: function() {
          var addressListObj = this
          var addressNodes = this.props.data.map(function(address, index) {
            return (
              <li className="collection-item">
                <Address
                  unit_number={address.unit_number}
                  street_address={address.street_address}
                  city={address.city}
                  province={address.province}
                  postal_code={address.postal_code}
                  onClick={addressListObj.handleClicked} />
              </li>
            );
          });
          return (
            <div className="card">
                <div className="card-content">
                  <div className="addressList">
                    <span className="card-title grey-text">Addresses</span>
                    <ul className="collection">
                      {addressNodes}
                    </ul>
                  </div>
                </div>
            </div>
          );
        }
      });

      var AddressForm = React.createClass({
        handleSubmit: function(e) {
          e.preventDefault();
          var street_address = this.refs.street_address.getDOMNode().value.trim();
          var unit_number = this.refs.unit_number.getDOMNode().value.trim();
          var city = this.refs.city.getDOMNode().value.trim();
          var province = this.refs.province.getDOMNode().value.trim();
          var postal_code = this.refs.postal_code.getDOMNode().value.trim();
          if (!street_address || !unit_number || !city || !province || !postal_code) {
            return;
          }
          this.refs.street_address.getDOMNode().value = '';
          this.refs.unit_number.getDOMNode().value = '';
          this.refs.city.getDOMNode().value = '';
          this.refs.province.getDOMNode().value = '';
          this.refs.postal_code.getDOMNode().value = '';
          this.props.onAddressSubmit({street_address: street_address, unit_number: unit_number, city: city, province: province, postal_code: postal_code})
          return;
        },
        render: function() {
          return (
            <div className="card">
              <div className="card-content">
                <div className="row">
                  <form className="addressForm col s12" onSubmit={this.handleSubmit}>
                    <div className="row">
                      <div className="input-field col s2">
                        <label htmlFor="unit_number">Unit</label>
                        <input type="text" id="unit_number" ref="unit_number" />
                      </div>
                      <div className="input-field col s5">
                        <label htmlFor="street_address">Street Address</label>
                        <input type="text" id="street_address" ref="street_address" />
                      </div>
                      <div className="input-field col s5">
                        <label htmlFor="city">City</label>
                        <input type="text" id="city" ref="city" />
                      </div>
                    </div>
                    <div className="row">
                      <div className="input-field col s6">
                        <label htmlFor="province">Province</label>
                        <input type="text" id="province" ref="province" />
                      </div>
                      <div className="input-field col s6">
                        <label htmlFor="postal_code">Postal Code</label>
                        <input type="text" id="postal_code" ref="postal_code" />
                      </div>
                    </div>
                    <button className="btn waves-effect waves-light" type="submit" name="action">Submit
                      <i className="mdi-content-send right"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          );
        }
      });

      var Address = React.createClass({
        propTypes: {
          unit_number: React.PropTypes.string.isRequired,
          street_address: React.PropTypes.string.isRequired,
          city: React.PropTypes.string.isRequired,
          province: React.PropTypes.string.isRequired,
          postal_code: React.PropTypes.string.isRequired,
          onClick: React.PropTypes.func.isRequired
        },
        handleClicked: function() {
          this.props.onClick(this);
        },
        render: function() {
          return (
            <div>
              <div className="address">
                {this.props.unit_number} - {this.props.street_address} {this.props.city} {this.props.province} {this.props.postal_code}
              </div>
              <a className="btn-floating btn-large waves-effect waves-light red" onClick={this.handleClicked.bind(this)}><i className="mdi-content-remove"></i></a>
            </div>
          );
        }
      });

    React.render(
      <AddressBox url="addresses.json"/>,
        document.getElementById('content')
      );
    </script>
  </body>
</html>
